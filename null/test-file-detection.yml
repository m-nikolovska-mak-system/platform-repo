name: Test File Change Detection
# Simple test workflow to verify file detection works

on:
  # Allow manual testing
  workflow_dispatch:
    inputs:
      current_tag:
        description: 'Tag to check (e.g., v1.0.1)'
        required: true
        type: string
      previous_tag:
        description: 'Compare against (leave empty for auto-detect)'
        required: false
        type: string
      test_files:
        description: 'Files to watch (one per line)'
        required: false
        type: string
        default: |
          src/App.java
          pom.xml

  # Also trigger on actual releases
  release:
    types: [published]

jobs:
  test-detection:
    name: Test File Change Detection
    uses: m-nikolovska-mak-system/reusable-actions-library/.github/workflows/3check-file-changes.yml@main
    with:
      watched_files: ${{ github.event.inputs.test_files || 'oneProjectWed/src/java/com/miha/app/App.java' }}
      current_tag: ${{ github.event.inputs.current_tag || github.event.release.tag_name }}
      previous_tag: ${{ github.event.inputs.previous_tag || '' }}

  show-results:
    name: Display Results
    needs: test-detection
    runs-on: ubuntu-latest
    steps:
      - name: Show what was detected
        run: |
          echo "=========================================="
          echo "ðŸ§ª FILE DETECTION TEST RESULTS"
          echo "=========================================="
          echo ""
          echo "ðŸ“Š Comparison: ${{ needs.test-detection.outputs.comparison_info }}"
          echo ""
          
          if [ "${{ needs.test-detection.outputs.files_changed }}" = "true" ]; then
            echo "âœ… STATUS: Watched files CHANGED"
            echo ""
            echo "ðŸ“ Changed watched files:"
            echo "${{ needs.test-detection.outputs.changed_files_list }}" | tr ',' '\n' | sed 's/^/  âœ“ /'
          else
            echo "âŒ STATUS: No watched files changed"
          fi
          
          echo ""
          echo "ðŸ“‚ All files changed in release:"
          if [ -n "${{ needs.test-detection.outputs.all_changed_files }}" ]; then
            echo "${{ needs.test-detection.outputs.all_changed_files }}" | tr ',' '\n' | sed 's/^/  â€¢ /' | head -20
          else
            echo "  (none)"
          fi
          echo ""
          echo "=========================================="
      
      - name: Create test summary
        run: |
          echo "# ðŸ§ª File Detection Test Results" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "## Comparison" >> $GITHUB_STEP_SUMMARY
          echo "\`${{ needs.test-detection.outputs.comparison_info }}\`" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          if [ "${{ needs.test-detection.outputs.files_changed }}" = "true" ]; then
            echo "## âœ… Result: Files Changed" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "Changed files:" >> $GITHUB_STEP_SUMMARY
            echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
            echo "${{ needs.test-detection.outputs.changed_files_list }}" | tr ',' '\n' >> $GITHUB_STEP_SUMMARY
            echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
          else
            echo "## âŒ Result: No Changes" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "The watched files were not modified between releases." >> $GITHUB_STEP_SUMMARY
          fi
