# ========================================
# APPROACH 1: Config-Driven (Better for Enterprises)
# ========================================
# 
# This approach separates configuration from workflow logic.
# All team-specific settings are in a separate config file.
# 
# Benefits:
# - Easier to review (config is separate from workflow code)
# - Less error-prone (validate config independently)
# - Better for multiple teams (each has their own config)
# - Follows separation of concerns principle
# ========================================

name: Sync to Platform Repo

on:
  release:
    types: [published]

jobs:
  # Load configuration from file
  load-config:
    runs-on: ubuntu-latest
    outputs:
      source_files: ${{ steps.config.outputs.source_files }}
      destination_repo: ${{ steps.config.outputs.destination_repo }}
      destination_path: ${{ steps.config.outputs.destination_path }}
      tag_prefix: ${{ steps.config.outputs.tag_prefix }}
      sync_mode: ${{ steps.config.outputs.sync_mode }}
      preserve_structure: ${{ steps.config.outputs.preserve_structure }}
      create_tag: ${{ steps.config.outputs.create_tag }}
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
      
      - name: Load sync configuration
        id: config
        run: |
          # Read config from YAML file
          # Install yq if needed
          sudo wget -qO /usr/local/bin/yq https://github.com/mikefarah/yq/releases/latest/download/yq_linux_amd64
          sudo chmod +x /usr/local/bin/yq
          
          CONFIG_FILE=".github/sync-config.yml"
          
          # Extract values and set as outputs
          echo "source_files<<EOF" >> $GITHUB_OUTPUT
          yq eval '.source_files[]' "$CONFIG_FILE" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT
          
          echo "destination_repo=$(yq eval '.destination_repo' $CONFIG_FILE)" >> $GITHUB_OUTPUT
          echo "destination_path=$(yq eval '.destination_path' $CONFIG_FILE)" >> $GITHUB_OUTPUT
          echo "tag_prefix=$(yq eval '.tag_prefix' $CONFIG_FILE)" >> $GITHUB_OUTPUT
          echo "sync_mode=$(yq eval '.sync_mode' $CONFIG_FILE)" >> $GITHUB_OUTPUT
          echo "preserve_structure=$(yq eval '.preserve_structure' $CONFIG_FILE)" >> $GITHUB_OUTPUT
          echo "create_tag=$(yq eval '.create_tag' $CONFIG_FILE)" >> $GITHUB_OUTPUT
  
  # Call reusable workflow with loaded config
  sync-to-platform:
    name: Sync Files to Platform
    needs: load-config
    uses: m-nikolovska-mak-system/reusable-actions-library/.github/workflows/sync-to-platform-reusable.yml@main
    
    with:
      source_files: ${{ needs.load-config.outputs.source_files }}
      destination_repo: ${{ needs.load-config.outputs.destination_repo }}
      destination_path: ${{ needs.load-config.outputs.destination_path }}
      tag_prefix: ${{ needs.load-config.outputs.tag_prefix }}
      sync_mode: ${{ needs.load-config.outputs.sync_mode }}
      preserve_structure: ${{ needs.load-config.outputs.preserve_structure == 'true' }}
      create_tag: ${{ needs.load-config.outputs.create_tag == 'true' }}
      commit_message_template: 'ðŸ”„ Sync from {repo} release {tag} ({files} files)'
    
    secrets:
      destination_token: ${{ secrets.PLATFORM_PAT }}
