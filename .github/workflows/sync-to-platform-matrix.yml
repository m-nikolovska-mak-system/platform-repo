# ========================================
# Matrix-Based File Sync Workflow
# ========================================
name: Sync to Platform Repo (Matrix)

on:
  workflow_dispatch:  # Manual testing
  release:
    types: [published]

jobs:
  # ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  # JOB 1: Load and Validate Config
  # ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  load-matrix:
    name: Load Sync Matrix
    runs-on: ubuntu-latest
    outputs:
      matrix: ${{ steps.set-matrix.outputs.matrix }}
      destination_repo: ${{ steps.global.outputs.destination_repo }}
      create_tag: ${{ steps.global.outputs.create_tag }}
      tag_prefix: ${{ steps.global.outputs.tag_prefix }}
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
      
      - name: Install yq
        run: |
          sudo wget -qO /usr/local/bin/yq https://github.com/mikefarah/yq/releases/latest/download/yq_linux_amd64
          sudo chmod +x /usr/local/bin/yq
      
      - name: Validate config file exists
        run: |
          if [ ! -f .github/sync-config.yml ]; then
            echo "‚ùå ERROR: Config file not found at .github/sync-config.yml"
            exit 1
          fi
          echo "‚úÖ Config file found"
      
      - name: Load global settings
        id: global
        run: |
          CONFIG_FILE=".github/sync-config.yml"
          
          DEST_REPO=$(yq eval '.destination_repo' $CONFIG_FILE)
          CREATE_TAG=$(yq eval '.create_tag' $CONFIG_FILE)
          TAG_PREFIX=$(yq eval '.tag_prefix' $CONFIG_FILE)
          
          # Validate required fields
          if [ "$DEST_REPO" == "null" ] || [ -z "$DEST_REPO" ]; then
            echo "‚ùå ERROR: destination_repo is required in config"
            exit 1
          fi
          
          echo "destination_repo=$DEST_REPO" >> $GITHUB_OUTPUT
          echo "create_tag=$CREATE_TAG" >> $GITHUB_OUTPUT
          echo "tag_prefix=$TAG_PREFIX" >> $GITHUB_OUTPUT
          
          echo "üìã Global Settings:"
          echo "  Destination: $DEST_REPO"
          echo "  Create tag: $CREATE_TAG"
          echo "  Tag prefix: $TAG_PREFIX"
      
      - name: Build and validate matrix
        id: set-matrix
        run: |
          CONFIG_FILE=".github/sync-config.yml"
          
          # Convert YAML mappings to compact JSON (one line)
          MATRIX=$(yq eval -o=json '.mappings' "$CONFIG_FILE" | jq -c '.')
          
          # Validate matrix is not empty
          if [ "$MATRIX" = "null" ] || [ "$MATRIX" = "[]" ]; then
            echo "‚ùå ERROR: No mappings found in config"
            exit 1
          fi
          
          # Count mappings
          COUNT=$(echo "$MATRIX" | jq '. | length')
          echo "üìã Found $COUNT mapping(s)"
          
          # Validate each mapping has required fields
          echo "$MATRIX" | jq -r '.[] | select(.name == null or .source == null or .destination == null) | .name // "unnamed"' | while read -r invalid; do
            echo "‚ùå ERROR: Mapping missing required fields: $invalid"
            exit 1
          done
          
          # Write matrix output (must be single-line key=value)
          echo "matrix=$MATRIX" >> "$GITHUB_OUTPUT"
          
          # Display mappings
          echo ""
          echo "üìã Mappings to process:"
          echo "$MATRIX" | jq -r '.[] | "  ‚úì \(.name): \(.source | length) file(s) ‚Üí \(.destination)"'


  # ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  # JOB 2: Sync Files (Runs per mapping)
  # ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  sync-files:
    name: üì¶ ${{ matrix.mapping.name }}
    needs: load-matrix
    runs-on: ubuntu-latest
    
    strategy:
      matrix:
        mapping: ${{ fromJson(needs.load-matrix.outputs.matrix) }}
      fail-fast: false
      max-parallel: 3
    
    steps:
      - name: Checkout source repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          path: source
      
      - name: Checkout destination repository
        uses: actions/checkout@v4
        with:
          repository: ${{ needs.load-matrix.outputs.destination_repo }}
          token: ${{ secrets.PLATFORM_PAT }}
          fetch-depth: 0
          path: destination
      
      - name: Detect files to sync
        id: detect
        working-directory: source
        run: |
          echo "üîç Detecting files for: ${{ matrix.mapping.name }}"
          
          SYNC_MODE="${{ matrix.mapping.sync_mode || 'all' }}"
          echo "  Sync mode: $SYNC_MODE"
          
          # Get base list of files
          if [ "$SYNC_MODE" == "changed" ]; then
            # Find changed files since last tag
            git fetch --tags
            LATEST="${{ github.ref_name }}"
            PREVIOUS=$(git describe --tags --abbrev=0 ${LATEST}^ 2>/dev/null || echo "")
            
            if [ -z "$PREVIOUS" ]; then
              echo "  ‚ÑπÔ∏è  First release - syncing all files"
              git ls-files > all_files.txt
            else
              echo "  üìä Comparing $PREVIOUS ‚Üí $LATEST"
              git diff --name-only $PREVIOUS $LATEST > all_files.txt
            fi
          else
            # Sync all specified files
            echo "  üìä Syncing all specified files"
            git ls-files > all_files.txt
          fi
          
          # Filter by source patterns
          > files_to_sync.txt
          
          echo ""
          echo "  üìÇ Checking source patterns:"
          echo '${{ toJson(matrix.mapping.source) }}' | jq -r '.[]' | while IFS= read -r pattern; do
            if [ -z "$pattern" ]; then
              continue
            fi
            
            echo "    ‚Ä¢ $pattern"
            
            # Check if pattern is a specific file or glob
            if [[ "$pattern" == *"*"* ]]; then
              # Glob pattern - convert to regex
              REGEX="${pattern//\*\*/DOUBLESTAR}"
              REGEX="${REGEX//\*/[^/]*}"
              REGEX="${REGEX//DOUBLESTAR/.*}"
              grep -E "^${REGEX}$" all_files.txt >> files_to_sync.txt 2>/dev/null || true
            else
              # Specific file - exact match
              grep -Fx "$pattern" all_files.txt >> files_to_sync.txt 2>/dev/null || true
            fi
          done
          
          # Remove duplicates
          sort -u files_to_sync.txt > files_to_sync_clean.txt || true
          mv files_to_sync_clean.txt files_to_sync.txt
          
          # Verify files exist
          > verified_files.txt
          while IFS= read -r file; do
            if [ -f "$file" ]; then
              echo "$file" >> verified_files.txt
            else
              echo "  ‚ö†Ô∏è  File not found: $file"
            fi
          done < files_to_sync.txt
          
          FILE_COUNT=$(wc -l < verified_files.txt 2>/dev/null || echo "0")
          
          echo ""
          echo "  ‚úÖ Found $FILE_COUNT file(s) to sync"
          
          if [ $FILE_COUNT -eq 0 ]; then
            echo "has_files=false" >> $GITHUB_OUTPUT
            echo "  ‚ö†Ô∏è  No files to sync for this mapping"
          else
            echo "has_files=true" >> $GITHUB_OUTPUT
            echo "file_count=$FILE_COUNT" >> $GITHUB_OUTPUT
            
            # Store file list
            echo "FILES_TO_SYNC<<EOF" >> $GITHUB_ENV
            cat verified_files.txt >> $GITHUB_ENV
            echo "EOF" >> $GITHUB_ENV
            
            echo ""
            echo "  üìÑ Files to sync:"
            cat verified_files.txt | sed 's/^/      /'
          fi
      
      - name: Copy files to destination
        if: steps.detect.outputs.has_files == 'true'
        run: |
          echo "üì¶ Copying files for: ${{ matrix.mapping.name }}"
          
          cd source
          
          DEST_BASE="../destination/${{ matrix.mapping.destination }}"
          mkdir -p "$DEST_BASE"
          
          PRESERVE="${{ matrix.mapping.preserve_structure }}"
          COPIED=0
          
          while IFS= read -r file; do
            if [ -z "$file" ] || [ ! -f "$file" ]; then
              continue
            fi
            
            # Determine destination path
            if [ "$PRESERVE" == "true" ]; then
              DEST_FILE="$DEST_BASE/$file"
              DEST_DIR=$(dirname "$DEST_FILE")
            else
              FILE_NAME=$(basename "$file")
              DEST_FILE="$DEST_BASE/$FILE_NAME"
              DEST_DIR="$DEST_BASE"
            fi
            
            mkdir -p "$DEST_DIR"
            cp -v "$file" "$DEST_FILE"
            echo "  ‚úì $file ‚Üí $DEST_FILE"
            COPIED=$((COPIED + 1))
            
          done <<< "$FILES_TO_SYNC"
          
          echo ""
          echo "  üìä Copied $COPIED file(s)"
          
          echo "copied_count=$COPIED" >> $GITHUB_OUTPUT
      
      - name: Generate summary
        if: always()
        run: |
          echo "## üì¶ ${{ matrix.mapping.name }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Source patterns:** ${{ matrix.mapping.source }}" >> $GITHUB_STEP_SUMMARY
          echo "**Destination:** \`${{ matrix.mapping.destination }}\`" >> $GITHUB_STEP_SUMMARY
          echo "**Preserve structure:** ${{ matrix.mapping.preserve_structure }}" >> $GITHUB_STEP_SUMMARY
          echo "**Sync mode:** ${{ matrix.mapping.sync_mode || 'all' }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          if [ "${{ steps.detect.outputs.has_files }}" == "true" ]; then
            echo "‚úÖ **Files synced:** ${{ steps.detect.outputs.file_count }}" >> $GITHUB_STEP_SUMMARY
          else
            echo "‚ö†Ô∏è **No files found to sync**" >> $GITHUB_STEP_SUMMARY
          fi


  # ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  # JOB 3: Single Commit & Push
  # ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  commit-and-push-all:
    name: Commit & Push All Mappings
    needs: [load-matrix, sync-files]
    runs-on: ubuntu-latest

    steps:
      - name: Checkout destination repo (latest main)
        uses: actions/checkout@v4
        with:
          repository: ${{ needs.load-matrix.outputs.destination_repo }}
          token: ${{ secrets.PLATFORM_PAT }}
          fetch-depth: 0
          path: destination

      - name: Checkout source repo
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          path: source

      - name: Re-run all mappings into destination
        working-directory: source
        run: |
          echo "üîÅ Re-running all mappings into a single destination workspace"

          CONFIG_FILE=".github/sync-config.yml"

          # Read matrix again
          MATRIX=$(yq eval -o=json '.mappings' "$CONFIG_FILE" | jq -c '.')

          # Prepare a clean working copy of destination
          DEST_ROOT="../destination"

          echo "$MATRIX" | jq -c '.[]' | while read -r mapping; do
            NAME=$(echo "$mapping" | jq -r '.name')
            DESTINATION=$(echo "$mapping" | jq -r '.destination')
            PRESERVE=$(echo "$mapping" | jq -r '.preserve_structure // "false"')

            echo ""
            echo "üì¶ Applying mapping: $NAME"
            echo "  Destination: $DESTINATION"
            echo "  Preserve structure: $PRESERVE"

            DEST_BASE="$DEST_ROOT/$DESTINATION"
            mkdir -p "$DEST_BASE"

            # Decide sync_mode: default 'all' unless overridden per mapping
            SYNC_MODE_GLOBAL=$(yq eval '.sync_mode // "all"' "$CONFIG_FILE")
            SYNC_MODE_MAPPING=$(echo "$mapping" | jq -r '.sync_mode // empty')
            SYNC_MODE="${SYNC_MODE_MAPPING:-$SYNC_MODE_GLOBAL}"
            echo "  Sync mode: $SYNC_MODE"

            # Base file list
            if [ "$SYNC_MODE" = "changed" ]; then
              git fetch --tags
              LATEST="${{ github.ref_name }}"
              PREVIOUS=$(git describe --tags --abbrev=0 ${LATEST}^ 2>/dev/null || echo "")
              if [ -z "$PREVIOUS" ]; then
                echo "  ‚ÑπÔ∏è First release - syncing all"
                git ls-files > all_files.txt
              else
                echo "  üìä Comparing $PREVIOUS ‚Üí $LATEST"
                git diff --name-only "$PREVIOUS" "$LATEST" > all_files.txt
              fi
            else
              git ls-files > all_files.txt
            fi

            # Filter by patterns
            > files_to_sync.txt
            echo "$mapping" | jq -r '.source[]' | while IFS= read -r pattern; do
              if [ -z "$pattern" ]; then
                continue
              fi
              echo "    ‚Ä¢ $pattern"
              if [[ "$pattern" == *"*"* ]]; then
                REGEX="${pattern//\*\*/DOUBLESTAR}"
                REGEX="${REGEX//\*/[^/]*}"
                REGEX="${REGEX//DOUBLESTAR/.*}"
                grep -E "^${REGEX}$" all_files.txt >> files_to_sync.txt 2>/dev/null || true
              else
                grep -Fx "$pattern" all_files.txt >> files_to_sync.txt 2>/dev/null || true
              fi
            done

            sort -u files_to_sync.txt > files_to_sync_clean.txt || true
            mv files_to_sync_clean.txt files_to_sync.txt

            while IFS= read -r file; do
              [ -z "$file" ] && continue
              [ ! -f "$file" ] && continue

              if [ "$PRESERVE" = "true" ]; then
                DEST_FILE="$DEST_BASE/$file"
                DEST_DIR=$(dirname "$DEST_FILE")
              else
                FILE_NAME=$(basename "$file")
                DEST_FILE="$DEST_BASE/$FILE_NAME"
                DEST_DIR="$DEST_BASE"
              fi

              mkdir -p "$DEST_DIR"
              cp -v "$file" "$DEST_FILE"
            done < files_to_sync.txt
          done

      - name: Commit and push once
        working-directory: destination
        run: |
          echo "üíæ Committing all synced changes"

          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

          git add .

          if git diff --staged --quiet; then
            echo "  ‚ÑπÔ∏è No changes detected (files identical)"
            exit 0
          fi

          TAG="${{ github.ref_name }}"
          REPO="${{ github.repository }}"
          MSG="üîÑ Sync from ${REPO} release ${TAG}"

          git commit -m "$MSG"

          # Pull + rebase to include any external changes, then push
          git pull --rebase origin main || true
          git push origin main

          echo "  ‚úÖ Pushed single sync commit"
        

  # ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  # JOB 4: Create Tag (Optional)
  # ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  create-tag:
    name: Create Release Tag
    needs: [load-matrix, sync-files]
    if: needs.load-matrix.outputs.create_tag == 'true'
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout destination
        uses: actions/checkout@v4
        with:
          repository: ${{ needs.load-matrix.outputs.destination_repo }}
          token: ${{ secrets.PLATFORM_PAT }}
          fetch-depth: 0
      
      - name: Create and push tag
        run: |
          TAG_NAME="${{ needs.load-matrix.outputs.tag_prefix }}${{ github.ref_name }}"
          
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          
          if git rev-parse "$TAG_NAME" >/dev/null 2>&1; then
            echo "‚ö†Ô∏è  Tag already exists: $TAG_NAME"
            exit 0
          fi
          
          git tag -a "$TAG_NAME" -m "Synced from ${{ github.repository }} (${{ github.ref_name }})"
          git push origin "$TAG_NAME"
          
          echo "‚úÖ Created tag: $TAG_NAME"

  # ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  # JOB 5: Final Summary
  # ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  summary:
    name: Summary
    needs: [load-matrix, sync-files]
    if: always()
    runs-on: ubuntu-latest
    
    steps:
      - name: Generate final summary
        run: |
          echo "# üéâ File Sync Complete" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Trigger:** ${{ github.event_name }}" >> $GITHUB_STEP_SUMMARY
          echo "**Source:** ${{ github.repository }}" >> $GITHUB_STEP_SUMMARY
          echo "**Release:** ${{ github.ref_name }}" >> $GITHUB_STEP_SUMMARY
          echo "**Destination:** ${{ needs.load-matrix.outputs.destination_repo }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "---" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "Check the individual mapping results above ‚òùÔ∏è" >> $GITHUB_STEP_SUMMARY
